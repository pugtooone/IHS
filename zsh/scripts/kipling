#! /bin/zsh

# script for Kipling batch to vendor
# created by Zeric Chan

# Problems
# 1) notify the user to update swatch base, say has not updated for 3 days

emulate -LR zsh
setopt extended_glob
setopt null_glob
setopt verbose
setopt xtrace

# applescript for dialog box for choosing folder
local target_folder_apple=$(osascript -e 'set theDocument to choose folder with prompt "Select the Kipling folder to process:"')
local target_folder=$(print $target_folder_apple | sed -e 's/alias //' -e 's/Macintosh HD//' -e 's/:/\//g')

# test if target_folder start with KPK
# if [[ -e ${target_folder:t} == KPK ]]; then

    # check the last modified time of the swatch base
    # if $(stat -f %Sm -t %Y%m%d ${SWATCH_BASE}) 

    cd $target_folder
    local PARENT="$(pwd)"
    
    # set swatch base for every different device
    local SWATCH_BASE="$HOME/Desktop/.kipling_swatch"
    
    touch swatch_search.txt
    local SWATCH_SEARCH="$PARENT/swatch_search.txt"
    mkdir new_swatch
    local NEW_SWATCH="$PARENT/new_swatch"
    
    if [[ ! -d Images ]]; then
        mkdir Images
    fi
    
    # array for Kipling grid size
    
    typeset -a GRID=( A1 A2 A3 A4 A5 B1 B2 B3 B4 B5 B6 TBC )
    
    # move all product folders to the designated master grid size folders
    
    for (( i=1 ; i<13 ; i++ )); do

	    for dir in **/"${GRID[i]}"; do

		    mkdir Images/"${GRID[i]}"
		    local MGRID="${PARENT}/Images/${GRID[i]}"

		    for dir in [^I]*/**/${GRID[i]}; do
                	    
			    ls -1 $dir | while read; do

			    print "OR name: ${REPLY: -3}" >> $SWATCH_SEARCH

			        if [[ -e $SWATCH_BASE/${REPLY: -3}.jpg || -e $SWATCH_BASE/${REPLY: -3}.tif ]]; then
			            
				        cp $SWATCH_BASE/${REPLY: -3}.jpg ${dir}/${REPLY}

			        else

					# duplicate the swatch into the product folder itself
					cp ${dir}/${REPLY}/${REPLY}_1.tif ${dir}/${REPLY}/${REPLY: -3}.tif
					# copy to new_swatch directory
				        cp ${dir}/${REPLY}/${REPLY}_1.tif ${NEW_SWATCH}/${REPLY: -3}.tif
					# another copy to swatch base to prevent duplicates of new swatch
				        cp ${dir}/${REPLY}/${REPLY}_1.tif ${SWATCH_BASE}/new_${REPLY: -3}.tif 

			        fi

			    done
			    
			    cd $dir
			    mv -i KPK* $MGRID
			    cd $PARENT

		    done
	    done
    done

    touch tmp.txt
    cat $SWATCH_SEARCH | sort | uniq > tmp.txt
    cat tmp.txt > $SWATCH_SEARCH
    rm tmp.txt

#else

#	print "target directory missing!!!"

#fi
